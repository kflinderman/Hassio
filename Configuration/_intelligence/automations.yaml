##################################
# Jump to Section                #
#                                #
# #0 Bedroom Automations         #
# #1 Nursery Automations         #
# #2 Craft Room Automations      #
# #3 Living Room Automations     #
# #4 Kitchen Automations         #
# #5 Dining Room Automations     #
# #6 Basement Automations        #
# #7 Guest Room Automations      #
# #8 Sun Room Automations        #
# #9 Outside Automations         #
# #A Bedtime Automations         #
# #B Location Automations        #
# #C PC Automations              #
# #D Vacuum Automations          #
# #E Master Switches Automations #
# #F Notifications Automations   #
# #G Weather Automations         #
# #H Home Assistant Automations  #
# #I Other Automations           #
##################################













########################
#0 Bedroom Automations #
########################

- id: bedroom_lights
  alias: Bedroom Lights
  mode: restart
  trigger:
    - platform: state
      entity_id: sensor.bedroom_multisensor_burglar
    - platform: state
      entity_id: input_boolean.sexy_time
  action:
    - choose:
      - conditions:
         - condition: and
           conditions:
            - condition: numeric_state
              entity_id: sensor.bedroom_multisensor_burglar
              above: 4
            - condition: numeric_state
              entity_id: sensor.bedroom_multisensor_luminance
              below: 13
            - condition: state
              entity_id: input_boolean.bedroom
              state: 'on'
            - condition: state
              entity_id:
                - input_boolean.sexy_time
                - light.swirl_lamp
                - switch.bedfan
              state: 'off'
            - condition: or
              conditions:
                - condition: state
                  entity_id: group.residents
                  state: home
                - condition: state
                  entity_id: input_boolean.im_home
                  state: 'on'
                - condition: state
                  entity_id: input_boolean.sexy_time
                  state: 'off'
        sequence:
          - service: light.turn_on
            entity_id: light.swirl_lamp
          - service: switch.turn_on
            entity_id: switch.bedfan
      - conditions:
          - condition: and
            conditions:
            - condition: numeric_state
              entity_id: sensor.bedroom_multisensor_burglar
              below: 4
            - condition: state
              entity_id:
                - input_boolean.sexy_time
                - group.bedroom
              state: 'on'
            - condition: state
              entity_id: input_boolean.vacation
              state: 'off'
            - condition: time
              after: '8:00:00'
        sequence:
          - delay:
              minutes: 5
          - condition: numeric_state
            entity_id: sensor.bedroom_multisensor_burglar
            below: 4 
          - service: input_boolean.turn_on
            entity_id: input_boolean.bedroom_motion
          - delay:
              seconds: 2
          - service: homeassistant.turn_off
            entity_id: group.bedroom
          - delay:
              seconds: 2
          - service: input_boolean.turn_off
            entity_id: input_boolean.bedroom_motion

- id: allow_motion_bedroom
  alias: Allow Motion Bedroom
  trigger:
  - platform: time_pattern
    minutes: '/5'
    seconds: '00'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.bedroom
        state: 'off'
      - condition: time
        before: '22:00:00'
      - condition: or
        conditions:
        - condition: time
          after: '8:00:00'
          weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
        - condition: time
          after: '10:00:00'
          weekday:
          - sat
          - sun
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.bedroom

- id: bedroom_stop_motion
  alias: Bedroom Stop Motion
  trigger:
    - entity_id: switch.bedfan
      platform: state
      to: 'off'
    - entity_id: light.swirl_lamp
      platform: state
      to: 'off'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.bedroom_motion
        state: 'off'
      - condition: or
        conditions:
        - condition: time
          after: '20:30:00'
        - condition: time
          before: '8:00:00'
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.goodnight

- id: sexy_time_over
  alias: Sexy Time Over
  trigger:
    - entity_id: light.swirl_lamp
      platform: state
      to: 'on'
      for: 
        hours: 1
  condition:
    - condition: state
      entity_id: input_boolean.sexy_time
      state: 'on'
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.sexy_time

- id: bedroom_fan
  alias: Bedroom Fan
  trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: sensor.outside_temp
  action:
    - choose:
      - conditions:
          - condition: numeric_state
            entity_id: sensor.outside_temp
            above: 70
        sequence:
          - service: group.set
            data:
              object_id: bedroom
              entities: light.swirl_lamp, switch.masterbath
      - conditions:
          - condition: numeric_state
            entity_id: sensor.outside_temp
            below: 65
        sequence:
          - service: group.set
            data:
              object_id: bedroom
              entities: light.swirl_lamp, switch.bedfan, switch.masterbath

########################
#1 Nursery Automations #
########################

- id: thingy_sensor_battery
  alias: Thingy Sensor Battery
  trigger:
    - platform: numeric_state
      entity_id: sensor.thingy_battery_level
      below: 10
      for:
        minutes: 60
  action:
    - service: notify.mobile_app_pixel_3a_xl
      data:
        title: Thingy Sensor Low Battery
        message: "The thingy sensor has very low battery."

- id: night_nursery
  alias: Night Nursery
  trigger:
    - platform: state
      entity_id: switch.upstairs_hallway_switch
  condition:
    - condition: or
      conditions:
      - condition: time
        after: '22:00:00'
      - condition: time
        before: '7:00:00'
  action:
    - choose:
      - conditions:
          - condition: state
            entity_id: switch.upstairs_hallway_switch
            state: 'on'
        sequence:
          - service: light.turn_on
            entity_id: light.nursery_light
      - conditions:
          - condition: state
            entity_id: switch.upstairs_hallway_switch
            state: 'off'
        sequence:
          - service: light.turn_off
            entity_id: light.nursery_light

###########################
#2 Craft Room Automations #
###########################

- id: sewing_lights
  alias: Sewing Lights
  trigger:
    - platform: state
      entity_id: switch.craftfan
  action:
    - choose:
      - conditions:
          - condition: and
            conditions:
              - condition: state
                entity_id: switch.craftfan
                state: 'on'
              - condition: state
                entity_id: light.sewing_light
                state: 'off'
        sequence:
          - service: light.turn_on
            entity_id: light.sewing_light
      - conditions:
          - condition: and
            conditions:
              - condition: state
                entity_id: switch.craftfan
                state: 'off'
              - condition: state
                entity_id: light.sewing_light
                state: 'on'
        sequence:
          - service: light.turn_off
            entity_id: light.sewing_light

- id: craft_occupancy
  alias: Craft Occupancy
  trigger:
    - platform: state
      entity_id: group.craft
  action:
    - choose:
      - conditions:
          - condition: state
            entity_id: group.craft
            state: 'on'
        sequence:
          - service: input_boolean.turn_on
            entity_id: input_boolean.craftroom_occupancy
      - conditions:
          - condition: state
            entity_id: group.craft
            state: 'off'
        sequence:
          - service: input_boolean.turn_off
            entity_id: input_boolean.craftroom_occupancy

- id: craft_room_no_occupancy
  alias: Craft Room No Occupancy
  trigger:
    - platform: state
      entity_id: binary_sensor.craft_room_occupancy
      to: 'off'
      for:
        minutes: 15
  condition:
    - condition: state
      entity_id: group.craft
      state: 'on'
  action:
    - service: homeassistant.turn_off
      entity_id: group.craft

############################
#3 Living Room Automations #
############################

- id: living_room_motion
  alias: Living Room Motion
  trigger:
    - platform: state
      entity_id: binary_sensor.living_room_bay_occupancy
      to: 'on'
  condition:
    condition: and
    conditions:
    - condition: time
      before: '23:30:00'
    - condition: time
      after: '5:30:00'
    - condition: numeric_state
      entity_id: sensor.living_room_light_level
      below: 15
    - condition: state
      entity_id: input_boolean.livingroom
      state: 'on'
    - condition: or
      conditions:
        - condition: state
          entity_id: group.residents
          state: home
        - condition: state
          entity_id: input_boolean.im_home
          state: 'on'
  action:
    - service: light.turn_on
      entity_id: group.livingroom

- id: lights_day_dark
  alias: Lights Day Dark
  trigger:
    - platform: state
      entity_id: sensor.living_room_light_level
  condition:
    condition: and
    conditions:
    - condition: time
      after: '06:30:00'
    - condition: time
      before: '22:00:00'
    - condition: state
      entity_id: group.residents
      state: not_home
    - condition: state
      entity_id: input_boolean.im_home
      state: 'off'
  action:
    - choose:
      - conditions:
          - condition: and
            conditions:
            - condition: numeric_state
              entity_id: sensor.living_room_light_level
              below: 8
            - condition: state
              entity_id: light.floor_lamp
              state: 'off'
        sequence:
          - service: light.turn_on
            entity_id: light.floor_lamp
      - conditions:
          - condition: and
            conditions:
            - condition: numeric_state
              entity_id: sensor.living_room_light_level
              above: 12
            - condition: state
              entity_id: light.floor_lamp
              state: 'on'
        sequence:
          - service: light.turn_off
            entity_id: light.floor_lamp

- id: living_room_lights_off
  alias: Living Room Lights Off
  mode: restart
  trigger:
    - platform: state
      entity_id: binary_sensor.living_room_bay_occupancy
      to: 'off'
      for:
        minutes: 15
  condition:
    - condition: state
      entity_id: group.livingroom
      state: 'on'
    - condition: state
      entity_id: input_boolean.party
      state: 'off'
    - condition: or
      conditions:
        - condition: state
          entity_id: media_player.living_room_tv
          state: 'unavailable'
        - condition: state
          entity_id: media_player.living_room_tv
          state: 'off'
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.livingroom_motion
    - service: input_boolean.turn_off
      entity_id: input_boolean.livingroom
    - delay:
        seconds: 2
    - service: light.turn_off
      entity_id: group.livingroom
    - delay:
        seconds: 2
    - service: input_boolean.turn_off
      entity_id: input_boolean.livingroom_motion
    - delay:
        seconds: 10
    - service: input_boolean.turn_on
      entity_id: input_boolean.livingroom

- id: living_room_stereo
  alias: Living Room Stereo
  mode: restart
  trigger:
    - platform: state
      entity_id: media_player.living_room_tv
  action:
    - choose:
      - conditions:
          - condition: and
            conditions:
            - condition: state
              entity_id: media_player.living_room_tv
              state: 'on'
            - condition: state
              entity_id: media_player.stereo
              state: 'off'
        sequence:
          - service: media_player.turn_on
            entity_id: media_player.stereo
      - conditions:
          - condition: and
            conditions:
            - condition: state
              entity_id: media_player.living_room_tv
              state: 'off'
            - condition: state
              entity_id: media_player.stereo
              state: 'on'
        sequence:
          - delay:
              minutes: 1
          - condition: state
            entity_id: media_player.living_room_tv
            state: 'off'
          - service: media_player.turn_off
            entity_id: media_player.stereo

- id: tv_off
  alias: TV Off
  trigger:
    - platform: state
      entity_id: media_player.stereo
      to: 'off'
  condition:
    condition: or
    conditions:
    - condition: state
      entity_id: media_player.living_room_tv
      state: 'on'
    - condition: state
      entity_id: media_player.living_room_tv
      state: 'playing'
  action:
    service: media_player.turn_off
    entity_id: media_player.living_room_tv

- id: living_room_stop_motion
  alias: Living Room Stop Motion
  trigger:
    - entity_id: light.rock_lamp
      platform: state
      to: 'off'
    - entity_id: light.chair_lamp
      platform: state
      to: 'off'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.livingroom_motion
        state: 'off'
      - condition: or
        conditions:
        - condition: time
          after: '22:00:00'
        - condition: time
          before: '8:00:00'
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.livingroom

########################
#4 Kitchen Automations #
########################

- id: kitchen_lights
  alias: Kitchen Lights
  mode: restart
  trigger:
    - platform: state
      entity_id: sensor.kitchen_burglar
  action:
    - choose:
      - conditions:
          - condition: and
            conditions:
            - condition: numeric_state
              entity_id: sensor.kitchen_burglar
              above: 4
            - condition: numeric_state
              entity_id: sensor.kitchen_luminance
              above: 15
            - condition: state
              entity_id: input_boolean.kitchen
              state: 'on'
            - condition: state
              entity_id:
                - light.sink_light
                - switch.cabinet_lights
                - switch.cabinet_lights_2
              state: 'off'
            - condition: or
              conditions:
                - condition: state
                  entity_id: group.residents
                  state: home
                - condition: state
                  entity_id: input_boolean.im_home
                  state: 'on'
        sequence:
          - service: homeassistant.turn_on
            entity_id: group.kitchen_no_ceiling
      - conditions:
          - condition: and
            conditions:
            - condition: numeric_state
              entity_id: sensor.kitchen_burglar
              above: 4
            - condition: numeric_state
              entity_id: sensor.kitchen_luminance
              below: 16
            - condition: state
              entity_id: input_boolean.kitchen
              state: 'on'
            - condition: state
              entity_id:
                - light.sink_light
                - switch.cabinet_lights
                - switch.cabinet_lights_2
                - switch.kitchen_ceiling
              state: 'off'
            - condition: or
              conditions:
                - condition: state
                  entity_id: group.residents
                  state: home
                - condition: state
                  entity_id: input_boolean.im_home
                  state: 'on'
        sequence:
          - service: homeassistant.turn_on
            entity_id: group.kitchen
      - conditions:
          - condition: and
            conditions:
            - condition: numeric_state
              entity_id: sensor.kitchen_burglar
              below: 4
            - condition: state
              entity_id:
                - input_boolean.vacation
                - input_boolean.party
              state: 'off'
            - condition: state
              entity_id: group.kitchen
              state: 'on'
            - condition: time
              after: '8:00:00'
        sequence:
          - delay:
              minutes: 5
          - condition: numeric_state
            entity_id: sensor.kitchen_burglar
            below: 4 
          - service: input_boolean.turn_on
            entity_id: input_boolean.kitchen_motion
          - delay:
              seconds: 2
          - service: homeassistant.turn_off
            entity_id: group.kitchen
          - delay:
              seconds: 2
          - service: input_boolean.turn_off
            entity_id: input_boolean.kitchen_motion

- id: kitchen_sensor_battery
  alias: Kitchen Sensor Battery
  trigger:
    - platform: numeric_state
      entity_id: sensor.kitchensensorbatt
      below: 20
  action:
    - service: notify.mobile_app_pixel_3a_xl
      data:
        title: Kitchen Sensor Low Battery
        message: "The kitchen sensor has very low battery."

- id: kitchen_stop_motion
  alias: Kitchen Stop Motion
  trigger:
    - entity_id: light.sink_light
      platform: state
      to: 'off'
    - entity_id: switch.cabinet_lights
      platform: state
      to: 'off'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.kitchen_motion
        state: 'off'
      - condition: or
        conditions:
        - condition: time
          after: '22:00:00'
        - condition: time
          before: '8:00:00'
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.kitchen

############################
#5 Dining Room Automations #
############################

- id: dining_light_occupancy
  alias: Dining Light Occupancy
  trigger:
    - platform: state
      entity_id: group.dining_room
  action:
    - choose:
      - conditions:
          - condition: state
            entity_id: group.dining_room
            state: 'on'
        sequence:
          - service: input_boolean.turn_on
            entity_id: input_boolean.dining_room_occupancy
      - conditions:
          - condition: state
            entity_id: group.dining_room
            state: 'off'
        sequence:
          - service: input_boolean.turn_off
            entity_id: input_boolean.dining_room_occupancy

- id: dining_one_person_move_off_lights
  alias: Dining One Person Move Off Lights
  trigger:
    - platform: state
      entity_id: binary_sensor.basement_occupancy
      to: 'on'
      for:
        minutes: 15
    - platform: state
      entity_id: binary_sensor.bedroom_occupancy
      to: 'on'
      for:
        minutes: 15
    - platform: state
      entity_id: binary_sensor.kitchen_occupancy
      to: 'on'
      for:
        minutes: 15
    - platform: state
      entity_id: binary_sensor.living_room_bay_occupancy
      to: 'on'
      for:
        minutes: 15
    - platform: state
      entity_id: binary_sensor.craft_room_occupancy
      to: 'on'
      for:
        minutes: 15
  condition:
    condition: and
    conditions:
    - condition: numeric_state
      entity_id: sensor.numhome
      below: 2
      above: 0
    - condition: state
      entity_id: group.dining_room
      state: 'on'
    - condition: state
      entity_id:
        - input_boolean.party
        - input_boolean.visitor
      state: 'off'
  action:
    - service: homeassistant.turn_off
      entity_id: group.dining_room
    - service: input_boolean.turn_off
      entity_id: input_boolean.dining_room_occupancy

- id: dining_two_people_move_off_lights
  alias: Dining Two People Move Off Lights
  mode: restart
  trigger:
    - platform: state
      entity_id: binary_sensor.basement_occupancy
      to: 'on'
      for:
        minutes: 15
    - platform: state
      entity_id: binary_sensor.bedroom_occupancy
      to: 'on'
      for:
        minutes: 15
    - platform: state
      entity_id: binary_sensor.kitchen_occupancy
      to: 'on'
      for:
        minutes: 15
    - platform: state
      entity_id: binary_sensor.living_room_bay_occupancy
      to: 'on'
      for:
        minutes: 15
    - platform: state
      entity_id: binary_sensor.craft_room_occupancy
      to: 'on'
      for:
        minutes: 15
  condition:
    condition: and
    conditions:
    - condition: numeric_state
      entity_id: sensor.numhome
      below: 3
      above: 1
    - condition: numeric_state
      entity_id: counter.occupancy
      above: 1
    - condition: state
      entity_id: group.dining_room
      state: 'on'
    - condition: state
      entity_id:
        - input_boolean.party
        - input_boolean.visitor
      state: 'off'
  action:
    - delay:
        minutes: 30
    - condition: numeric_state
      entity_id: counter.occupancy
      above: 1
    - condition: numeric_state
      entity_id: sensor.numhome
      below: 3
      above: 1
    - condition: state
      entity_id: group.dining_room
      state: 'on'
    - service: homeassistant.turn_off
      entity_id: group.dining_room
    - service: input_boolean.turn_off
      entity_id: input_boolean.dining_room_occupancy

#########################
#6 Basement Automations #
#########################

- id: basement_lights_on
  alias: Basement Lights ON
  trigger:
    - platform: numeric_state
      entity_id: sensor.basement_multisensor_burglar
      above: 4
  condition:
    condition: and
    conditions:
    - condition: numeric_state
      entity_id: sensor.basement_multisensor_luminance
      below: 13
    - condition: state
      entity_id: input_boolean.basement
      state: 'on'
    - condition: state
      entity_id: group.basement_no_aux
      state: 'off'
    - condition: or
      conditions:
        - condition: state
          entity_id: group.residents
          state: home
        - condition: state
          entity_id: input_boolean.im_home
          state: 'on'
  action:
    - service: homeassistant.turn_on
      entity_id: group.basement_no_aux

- id: basement_lights_off
  alias: Basement Lights OFF
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.basement_bay_occupancy
      to: 'off'
      for:
        minutes: 5
  condition:
    condition: and
    conditions:
    - condition: state
      entity_id:
        - input_boolean.vacation
        - input_boolean.party
      state: 'off'
    - condition: state
      entity_id: group.basement_no_aux
      state: 'on'
    - condition: time
      after: '8:00:00'
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.basement_motion
    - delay:
        seconds: 2
    - service: homeassistant.turn_off
      entity_id: group.basement_no_aux
    - delay:
        seconds: 2
    - service: input_boolean.turn_off
      entity_id: input_boolean.basement_motion

- id: basement_lights_off_no_one
  alias: Basement Lights OFF No One
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.basement_occupancy
      to: 'off'
      for:
        minutes: 5
  condition:
    condition: and
    conditions:
    - condition: state
      entity_id: group.basement_no_pc
      state: 'on'
    - condition: state
      entity_id: binary_sensor.basement_bay_occupancy
      state: 'off'
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.basement_motion
    - delay:
        seconds: 2
    - service: homeassistant.turn_off
      entity_id: group.basement_no_aux
    - delay:
        seconds: 2
    - service: input_boolean.turn_off
      entity_id: input_boolean.basement_motion

- id: basement_stereo_on
  alias: Basement Stereo On
  trigger:
    - platform: state
      entity_id: sensor.desktop_q6f6v0s_current_username
      to: 'kenny'
  condition:
    - condition: state
      entity_id: media_player.basement_stereo
      state: 'off'
  action:
    - service: media_player.turn_on
      entity_id: media_player.basement_stereo
    - delay:
        seconds: 2
    - service: media_player.select_source
      data:
        entity_id: media_player.basement_stereo
        source: HDMI1

- id: basement_stereo_off
  alias: Basement Stereo Off
  trigger:
    - platform: state
      entity_id: light.lightpack
      to: 'off'
    - platform: state
      entity_id: light.lightpack
      to: 'unavailable'
  condition:
    condition: or
    conditions:
    - condition: time
      after: '23:00:00'
    - condition: time
      before: '04:00:00'
  action:
    - service: media_player.turn_off
      entity_id: media_player.basement_stereo

- id: basement_off_check
  alias: Basement Off Check
  trigger:
    - platform: state
      entity_id: light.basement_1
      to: 'off'
      for:
        minutes: 2
    - platform: state
      entity_id: light.basement_2
      to: 'off'
      for:
        minutes: 2
    - platform: state
      entity_id: light.basement_3
      to: 'off'
      for:
        minutes: 2
    - platform: state
      entity_id: light.basement_4
      to: 'off'
      for:
        minutes: 2
  condition:
    - condition: state
      entity_id:
        - light.basement_ceiling_lights
        - input_boolean.basement_light_off_loop
      state: 'on'
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.basement_light_off_loop
    - service: script.turn_on
      entity_id: script.basement_check

- id: basement_stop_motion
  alias: Basement Stop Motion
  trigger:
    - entity_id: light.basement_1
      platform: state
      to: 'off'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.basement_motion
        state: 'off'
      - condition: or
        conditions:
        - condition: time
          after: '22:00:00'
        - condition: time
          before: '8:00:00'
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.basement

- id: remote_stereo_control
  alias: Remote Stereo Control
  trigger:
  - event_data:
      action: call_service
    event_type: ifttt_webhook_received
    platform: event
  condition: []
  action:
  - data_template:
      entity_id: '{{ trigger.event.data.entity_id }}'
    service_template: '{{ trigger.event.data.service }}'

###########################
#7 Guest Room Automations #
###########################

- id: guest_occupancy
  alias: Guest Occupancy
  trigger:
    - platform: state
      entity_id: group.guest
  action:
    - choose:
      - conditions:
          - condition: state
            entity_id: group.guest
            state: 'on'
        sequence:
          - service: input_boolean.turn_on
            entity_id: input_boolean.guest_occupancy
      - conditions:
          - condition: state
            entity_id: group.guest
            state: 'off'
        sequence:
          - service: input_boolean.turn_off
            entity_id: input_boolean.guest_occupancy

#########################
#8 Sun Room Automations #
#########################

- id: turn_on_sun_room_lights_at_sunset
  alias: Turn on Sun Room lights at sunset
  trigger:
    - platform: sun
      event: sunset
      # offset: +00:30:00
  condition:
    - condition: state
      entity_id: media_player.sun_room_dot
      state: 'playing'
  action:
    - service: homeassistant.turn_on
      entity_id: group.sun_room

- id: sun_occupancy
  alias: Sun Occupancy
  trigger:
    - platform: state
      entity_id: group.sun_room
  action:
    - choose:
      - conditions:
          - condition: state
            entity_id: group.sun_room
            state: 'on'
        sequence:
          - service: input_boolean.turn_on
            entity_id: input_boolean.sunroom_occupancy
      - conditions:
          - condition: state
            entity_id: group.sun_room
            state: 'off'
        sequence:
          - service: input_boolean.turn_off
            entity_id: input_boolean.sunroom_occupancy

- id: money_thirsty
  alias: Money Thirsty
  trigger:
    - platform: numeric_state
      entity_id: sensor.money_plant_moisture
      below: 15
      for:
        minutes: 65
  action:
    - service: notify.residents
      data:
        title: Thirsty Plant
        message: "The Money Plant is a little dry and would like some water!"

########################
#9 Outside Automations #
########################

- id: turn_on_outside_light_at_sunset
  alias: Turn on outside light at sunset
  trigger:
    - platform: sun
      event: sunset
      # offset: +00:30:00
  action:
    - service: homeassistant.turn_on
      entity_id: group.outside
    - service: homeassistant.turn_on
      entity_id: group.holiday

- id: turn_on_outside_light_at_sunrise
  alias: Turn on outside light at sunrise
  trigger:
    - platform: sun
      event: sunrise
      offset: -01:00:00
  action:
    - service: homeassistant.turn_on
      entity_id: group.outside
    - service: homeassistant.turn_on
      entity_id: group.holiday

- id: turn_off_outside_light_at_sunrise
  alias: Turn off outside light at sunrise
  trigger:
    - platform: sun
      event: sunrise
      offset: +00:30:00
  action:
    - service: homeassistant.turn_off
      entity_id: group.outside
    # - service: homeassistant.turn_off
      # entity_id: group.holiday

- id: door_activity
  alias: Door Activity
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.skybell_front_door_button
      to: 'on'
    - platform: state
      entity_id: binary_sensor.skybell_front_door_motion
      to: 'on'
  condition:
    - condition: state
      entity_id: input_boolean.door
      state: 'off'
  action:
    - service: camera.snapshot
      data:
        entity_id: camera.front_door_last_activity
        filename: '/config/www/camerasnapshot/front_door_last_activity.jpg'
    - service: notify.mobile_app_pixel_3a_xl
      data:
        title: Door Activity
        message: "There is activity at the front door..."
        data:
          image: !secret img_location
    - service: notify.mobile_app_iphone
      data:
        title: Door Activity
        message: "There is activity at the front door..."
        data:
          attachment:
            url: !secret img_location
            content-type: JPEG
            hide-thumbnail: false
    - service: input_boolean.turn_on
      entity_id: input_boolean.door
    - delay:
        minutes: 3
    - service: input_boolean.turn_off
      entity_id: input_boolean.door

- id: front_door_motion_snooze
  alias: Front Door Motion Snooze
  mode: restart
  trigger:
    - platform: state
      entity_id: input_boolean.front_door_snooze
  action:
    - choose:
      - conditions:
          - condition: state
            entity_id: input_boolean.front_door_snooze
            state: 'on'
        sequence:
          - service: switch.turn_off
            entity_id: switch.skybell_front_door_motion_sensor
          - delay:
              minutes: 60
          - service: input_boolean.turn_off
            entity_id: input_boolean.front_door_snooze
      - conditions:
          - condition: state
            entity_id:
              - input_boolean.front_door_snooze
              - switch.skybell_front_door_motion_sensor
            state: 'off'
        sequence:
          - service: switch.turn_on
            entity_id: switch.skybell_front_door_motion_sensor

########################
#A Bedtime Automations #
########################

- id: kenny_wake_up
  alias: Kenny Wake Up
  trigger:
    - platform: time
      at: '06:45:00'
  condition:
    condition: or
    conditions:
    - condition: state
      entity_id: input_boolean.vacation
      state: 'on'
    - condition: and
      conditions:
      - condition: state
        entity_id: person.kenny
        state: home
      - condition: time
        weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
  action:
    - service: scene.turn_on
      entity_id: scene.wakeup_kenny
    - service: climate.set_preset_mode
      data:
        entity_id: climate.main_floor
        preset_mode: 'Wake'

- id: kenny_awake
  alias: Kenny Awake
  trigger:
    - platform: time
      at: '07:20:00'
  condition:
    condition: and
    conditions:
    - condition: state
      entity_id: person.kenny
      state: home
    - condition: time
      weekday:
      - mon
      - tue
      - wed
      - thu
      - fri
  action:
    - service: homeassistant.turn_on
      entity_id: group.kitchen
    - service: homeassistant.turn_on
      entity_id: group.dining_room
    - service: switch.turn_on
      entity_id: switch.entrance_switch

- id: mere_wake_up
  alias: Mere Wake Up
  trigger:
    - platform: time
      at: '06:30:00'
  condition:
    condition: or
    conditions:
    - condition: state
      entity_id: input_boolean.vacation
      state: 'on'
    - condition: and
      conditions:
      - condition: state
        entity_id: person.meredith
        state: home
      - condition: time
        weekday:
        - thu
  action:
    - service: homeassistant.turn_on
      entity_id: group.kitchen
    - service: homeassistant.turn_on
      entity_id: group.dining_room
    - service: switch.turn_on
      entity_id: switch.entrance_switch

- id: mere_wake_up_gym_day
  alias: Mere Wake Up Gym Day
  trigger:
    - platform: time
      at: '05:00:00'
  condition:
    condition: or
    conditions:
    - condition: state
      entity_id: input_boolean.vacation
      state: 'on'
    - condition: and
      conditions:
      - condition: state
        entity_id: person.meredith
        state: home
      - condition: time
        weekday:
        - mon
        - tue
        - wed
        - fri
  action:
    - service: homeassistant.turn_on
      entity_id: group.kitchen
    - service: homeassistant.turn_on
      entity_id: group.dining_room
    - service: switch.turn_on
      entity_id: switch.entrance_switch

- id: kenny_bed
  alias: Kenny Bed
  mode: restart
  trigger:
    - platform: state
      entity_id: group.livingroom
      to: 'off'
    - platform: state
      entity_id: group.basement_no_pc
      to: 'off'
    - platform: state
      entity_id: media_player.basement_stereo
      to: 'off'
  condition:
    condition: or
    conditions:
      - condition: time
        after: '23:31'
      - condition: time
        before: '3:30'
  action:
    - service: switch.turn_on
      entity_id: switch.entrance_switch
    - delay:
        minutes: 5
    - service: switch.turn_off
      entity_id: switch.entrance_switch

- id: vacation_bedtime
  alias: Vacation Bedtime
  trigger:
    platform: time
    at: '22:00:00'
  condition:
    condition: state
    entity_id: input_boolean.vacation
    state: 'on'
  action:
    - service: homeassistant.turn_on
      entity_id: group.bedroom
    - delay:
        minutes: 15
    - service: homeassistant.turn_off
      entity_id: group.bedroom

- id: bedtime
  alias: Bedtime
  trigger:
    - platform: time
      at: '22:30:00'
      # at: '23:30:00'
    - platform: state
      entity_id: binary_sensor.living_room_bay_occupancy
      to: 'off'
  condition:
    condition: and
    conditions:
    - condition: state
      entity_id:
        - binary_sensor.living_room_bay_occupancy
        - input_boolean.party
      state: 'off'
    - condition: time
      after: '22:30:00'
      # after: '23:30:00'
  action:
    - service: homeassistant.turn_off
      entity_id: group.dining_room
    - service: homeassistant.turn_off
      entity_id: group.hallways
    - service: homeassistant.turn_off
      entity_id: group.outside
    - service: homeassistant.turn_off
      entity_id: group.holiday

- id: goodnight_automation
  alias: Goodnight Automation
  trigger:
    - entity_id: input_boolean.goodnight
      platform: state
      to: 'on'
      from: 'off'
  condition:
    condition: or
    conditions:
      - condition: time
        after: '20:30:00'
      - condition: time
        before: '8:00:00'
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.bedroom
    - service: homeassistant.turn_off
      entity_id: group.bedroom
    - condition: time
      after: '21:00:00'
    - service: light.turn_off
      entity_id: light.basement_ceiling_lights
    - service: light.turn_on
      entity_id: light.basement_ceiling_lights
    - service: light.turn_off
      entity_id: light.basement_ceiling_lights
    - service: light.turn_on
      entity_id: light.basement_ceiling_lights
    - service: light.turn_off
      entity_id: light.basement_ceiling_lights
    - service: light.turn_on
      entity_id: light.basement_ceiling_lights

#########################
#B Location Automations #
#########################

- id: off_lights_leave
  alias: Off lights Leave
  trigger:
    - platform: state
      entity_id: person.kenny
      to:
        - not_home
        - Work
      for:
        minutes: 5
    - platform: state
      entity_id: person.meredith
      to:
        - not_home
        - Work
      for:
        minutes: 5
  condition:
    - condition: state
      entity_id:
        - person.kenny
        - person.meredith
      state:
        - not_home
        - Work
  action:
    - service: vacuum.set_fan_speed
      data_template:
        entity_id: vacuum.xiaomi_vacuum_cleaner
        fan_speed: "Turbo"
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.all_firstfloor
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.all_secondfloor
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.all_basement
    - service: light.turn_off
      entity_id: light.deck_light
    - service: homeassistant.turn_off
      entity_id: group.holiday
    - service: switch.turn_off
      entity_id: switch.deck_ceiling_outlet_switch
    - service: script.turn_on
      entity_id: script.run_vacuum
    - condition: state
      entity_id: input_boolean.window
      state: 'off'
    - service: climate.set_preset_mode
      data:
        entity_id: climate.main_floor
        preset_mode: 'Away'

- id: mere_leave_gym_day
  alias: Mere Leave Gym Day
  trigger:
    - platform: state
      entity_id: person.meredith
      from: home
  condition:
    condition: or
    conditions:
    - condition: state
      entity_id: input_boolean.vacation
      state: 'on'
    - condition: and
      conditions:
      - condition: time
        before: '7:00:00'
      - condition: time
        weekday:
        - mon
        - tue
        - wed
        - fri
  action:
    - service: homeassistant.turn_off
      entity_id: group.kitchen
    - service: homeassistant.turn_off
      entity_id: group.dining_room
    - service: homeassistant.turn_off
      entity_id: group.hallways
    - service: homeassistant.turn_off
      entity_id: group.hallways

- id: vacation_on
  alias: Vacation ON
  trigger:
    - platform: state
      entity_id: calendar.vacations
      to: 'on'
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.vacation

- id: vacation_off
  alias: Vacation OFF
  trigger:
    - platform: state
      entity_id: calendar.vacations
      to: 'off'
    - platform: state
      entity_id: group.residents
      to: home
    - platform: state
      entity_id: input_boolean.im_home
      to: 'on'
  condition:
    - condition: state
      entity_id: input_boolean.vacation
      state: 'on'
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.vacation

- id: temperature_vacation
  alias: Temperature Vacation
  trigger:
    - platform: time_pattern
      minutes: 0
      seconds: 5
  condition:
    condition: and
    conditions:
    - condition: state
      entity_id:
        - input_boolean.visitor
        - input_boolean.im_home
      state: 'off'
    - condition: state
      entity_id: input_boolean.vacation
      state: 'on'
    - condition: state
      entity_id: group.residents
      state: not_home
  action:
    - service: climate.set_preset_mode
      data:
        entity_id: climate.main_floor
        preset_mode: 'Vac'

- id: vacation_random_script
  alias: Vacation Random Script
  trigger:
    - platform: sun
      event: sunset
  condition:
    - condition: state
      entity_id: input_boolean.vacation
      state: 'on'
  action:
    - service: script.turn_on
      entity_id: script.rand_vac1

- id: turn_off_away_mode
  alias: Turn off away mode
  trigger:
    - platform: state
      entity_id: group.residents
      to: home
    - platform: state
      entity_id: input_boolean.im_home
      to: 'on'
  action:
    - service: vacuum.set_fan_speed
      data_template:
        entity_id: vacuum.xiaomi_vacuum_cleaner
        fan_speed: "Silent"
    - service: vacuum.return_to_base
      entity_id: vacuum.xiaomi_vacuum_cleaner
    - condition: state
      entity_id: input_boolean.window
      state: 'off'
    - service: script.turn_on
      entity_id: script.home_mode_check1
    - condition: time
      weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
    - condition: time
      after: '9:00:00'
      before: '16:30:00'
    - service: climate.set_preset_mode
      data:
        entity_id: climate.main_floor
        preset_mode: 'Home'

- id: turn_off_home_switch
  alias: Turn off home switch
  trigger:
    - platform: state
      entity_id: group.residents
      to: home
  condition:
    - condition: state
      entity_id: input_boolean.im_home
      state: 'on'
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.im_home

- id: ecobee_false_positive
  alias: Ecobee Fasle Positive
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.basement_bee_occupancy
      to: 'on'
    - platform: state
      entity_id: binary_sensor.bedroom_bee_occupancy
      to: 'on'
    - platform: state
      entity_id: binary_sensor.living_room_bee_occupancy
      to: 'on'
    - platform: state
      entity_id: binary_sensor.main_floor_bee_occupancy
      to: 'on'
  condition:
    condition: and
    conditions:
    - condition: time
      after: 09:00:00
    - condition: time
      before: '16:30:00'
    - condition: state
      entity_id: group.residents
      state: not_home
    - condition: state
      entity_id:
        - input_boolean.im_home
        - input_boolean.visitor
      state: 'off'
    - condition: time
      weekday:
      - mon
      - tue
      - wed
      - thu
      - fri
  action:
    - delay:
        seconds: 30
    - service: ecobee.resume_program
      entity_id: climate.main_floor

- id: turn_on_lights_after_sunset
  alias: Turn on lights after sunset
  trigger:
    - platform: state
      entity_id: group.residents
      to: home
    - platform: state
      entity_id: input_boolean.im_home
      to: 'on'
  condition:
    condition: and
    conditions:
    - condition: sun
      after: sunset
      after_offset: -01:00:00
    - condition: time
      before: '23:59:00'
  action:
    - service: homeassistant.turn_on
      entity_id: group.dining_room
    - service: switch.turn_on
      entity_id: switch.entrance_switch
    - service: light.turn_on
      entity_id: light.deck_light
    - service: switch.turn_on
      entity_id: switch.deck_ceiling_outlet_switch
    - condition: state
      entity_id: input_boolean.visitor
      state: 'on'
    - service: homeassistant.turn_on
      entity_id: group.guest

###################
#C PC Automations #
###################

- id: turn_on_pc_morning
  alias: Turn on PC morning
  trigger:
    - platform: time
      at: '7:00:00'
  condition:
    condition: and
    conditions:
    - condition: state
      entity_id: person.kenny
      state: home
    - condition: state
      entity_id: switch.desktopPC
      state: 'off'
  action:
    - service: switch.turn_on
      entity_id: switch.desktopPC
    
- id: turn_off_pc_night_weekend
  alias: Turn off PC night weekend
  trigger:
    - platform: time
      at: '03:30:00'
  condition:
    - condition: time
      weekday:
      - sat
      - sun
  action:
    - service: script.turn_on
      entity_id: script.cpu_off
    - service: media_player.turn_off
      entity_id: media_player.basement_stereo
    
- id: turn_off_pc_night_weekday
  alias: Turn off PC night weekday
  trigger:
    - platform: time
      at: '01:30:00'
  condition:
    - condition: time
      weekday:
      - mon
      - tue
      - wed
      - thu
      - fri
  action:
    - service: script.turn_on
      entity_id: script.cpu_off
    - service: media_player.turn_off
      entity_id: media_player.basement_stereo

- id: pc_state_home
  alias: PC State Home
  trigger:
    - platform: state
      entity_id: person.kenny
  action:
    - choose:
      - conditions:
          - condition: state
            entity_id: person.kenny
            state:
              - not_home
              - Work
        sequence:
          - service: script.turn_on
            entity_id: script.timed_cpu_off
          - service: media_player.turn_off
            entity_id: media_player.basement_stereo
      - conditions:
          - condition: and
            conditions:
            - condition: state
              entity_id: person.kenny
              state: home
            - condition: time
              after: '06:30:00'
            - condition: time
              before: '23:00:00'
            - condition: state
              entity_id: switch.desktopPC
              state: 'off'
        sequence:
          - service: switch.turn_on
            entity_id: switch.desktopPC

- id: pc_after_dark
  alias: PC after dark
  trigger:
    - platform: state
      entity_id: media_player.desktop_media
      to: playing
  condition:
    - condition: time
      after: '22:00:00'
  action:
    # - service: light.turn_on
      # entity_id: light.lightpack
    - service: homeassistant.turn_off
      entity_id: group.basement_no_aux
    
# - id: lightpack_cpu_on
  # alias: Lightpack CPU On
  # trigger:
    # - platform: state
      # entity_id: light.lightpack
      # from: 'unavailable'
  # action:
    # - service: input_boolean.turn_on
      # entity_id: input_boolean.cpu_lightpack
    # - delay:
        # seconds: 10
    # - service: light.turn_on
      # entity_id: light.lightpack
    # - delay:
        # seconds: 10
    # - service: light.turn_off
      # entity_id: light.lightpack

# - id: lightpack_cpu_go
  # alias: Lightpack CPU Go
  # trigger:
    # - platform: state
      # entity_id:  media_player.desktop_media
      # to: 'paused'
  # condition:
    # - condition: state
      # entity_id: input_boolean.cpu_lightpack
      # state: 'on'
  # action:
    # - service: input_boolean.turn_off
      # entity_id: input_boolean.cpu_lightpack
    # - delay:
        # seconds: 1
    # - service: light.turn_on
      # entity_id: light.lightpack
    # - delay:
        # seconds: 1
    # - service: light.turn_off
      # entity_id: light.lightpack

#######################
#D Vacuum Automations #
#######################

- id: complete_vacuum
  alias: Complete Vacuum
  trigger:
    - platform: numeric_state
      entity_id: sensor.vacuum_area
      above: 35
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.vacuum_daily

- id: daily_vacuum
  alias: Daily Vacuum
  trigger:
    - platform: sun
      event: sunrise
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.vacuum_daily
    - service: input_boolean.turn_off
      entity_id: input_boolean.vacuum_cancel

- id: run_daily_vacuum
  alias: Run Daily Vacuum
  trigger:
    - platform: time
      at: '9:30:00'
  condition:
    - condition: state
      entity_id: group.residents
      state: not_home
  action:
    - service: script.turn_on
      entity_id: script.run_vacuum

- id: run_daily_vacuum_covid
  alias: Run Daily Vacuum CoVID
  trigger:
    - platform: time
      at: '14:00:00'
  action:
    - service: input_select.select_option
      entity_id: input_select.fanmode
      data_template:
        option: "Turbo"
    - service: script.turn_on
      entity_id: script.run_vacuum

- id: charged_daily_vacuum
  alias: Charged Daily Vacuum
  trigger:
    - platform: numeric_state
      entity_id: sensor.vacuum_battery
      above: 70
  condition:
    - condition: state
      entity_id: group.residents
      state: not_home
  action:
    - service: script.turn_on
      entity_id: script.run_vacuum

- id: low_battery_vacuum
  alias: Low Battery Vacuum
  trigger:
    - platform: numeric_state
      entity_id: sensor.vacuum_battery
      below: 15
  action:
    - service: vacuum.return_to_base
      entity_id: vacuum.xiaomi_vacuum_cleaner

- id: set_fan_mode
  alias: Set Fan Mode
  trigger:
    - platform: state
      entity_id: input_select.fanmode
  action:
    - service: vacuum.set_fan_speed
      data_template:
        entity_id: vacuum.xiaomi_vacuum_cleaner
        fan_speed: "{{ states('input_select.fanmode') }}"

- id: update_input_select_fan_mode
  alias: Update Input Select Fan Mode
  trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: sensor.vacuum_fan
  condition:
    - condition: template
      value_template: "{{ state_attr('vacuum.xiaomi_vacuum_cleaner', 'fan_speed') != states('input_select.fanmode') }}"
  action:
    - service: input_select.select_option
      entity_id: input_select.fanmode
      data_template:
        option: "{{ state_attr('vacuum.xiaomi_vacuum_cleaner', 'fan_speed') }}"

- id: vacuum_upstairs_reset
  alias: Vacuum Upstairs Reset
  mode: single
  trigger:
    - platform: state
      entity_id: input_boolean.vacuum_upstairs
      to: 'on'
  action:
    - service: counter.reset
      entity_id: counter.upstairs_vacuum
    - delay:
        seconds: 5
    - service: input_boolean.turn_off
      entity_id: input_boolean.vacuum_upstairs

- id: vacuum_basement_reset
  alias: Vacuum Basement Reset
  mode: single
  trigger:
    - platform: state
      entity_id: input_boolean.vacuum_basement
      to: 'on'
  action:
    - service: counter.reset
      entity_id: counter.basement_vacuum
    - delay:
        seconds: 5
    - service: input_boolean.turn_off
      entity_id: input_boolean.vacuum_basement

- id: vacuum_error
  alias: Vacuum Error
  trigger:
    - platform: state
      entity_id: vacuum.xiaomi_vacuum_cleaner
      to: 'error'
      for:
        seconds: 10
  action:
    - service: script.turn_on
      entity_id: script.vacuum_error_brush
    - service: script.turn_on
      entity_id: script.vacuum_error_notify

- id: vacuum_reset_counter
  alias: Vacuum Reset Counter
  trigger:
    - platform: state
      entity_id: vacuum.xiaomi_vacuum_cleaner
      to: 'docked'
  action:
    - service: counter.reset
      entity_id: counter.robo_error
    - service: counter.increment
      entity_id: counter.robo_empty

- id: vacuum_really_stuck
  alias: Vacuum Really Stuck
  trigger:
    - platform: numeric_state
      entity_id: counter.robo_error
      below: 1
  action:
    - service: notify.mobile_app_pixel_3a_xl
      data:
        title: Robot Vacuum Error
        message: "{{ state_attr('vacuum.xiaomi_vacuum_cleaner', 'error') }}"

- id: increment_day_since_vacuum
  alias: Increment Day Since Vacuum
  trigger:
    - platform: time
      at: '00:01:00'
  action:
    - service: counter.increment
      entity_id: counter.basement_vacuum
    - service: counter.increment
      entity_id: counter.upstairs_vacuum

- id: vacuum_remote
  alias: Vacuum Remote
  trigger:
    - platform: state
      entity_id: input_boolean.vacuum_remote
  action:
    - choose:
      - conditions:
          - condition: state
            entity_id: input_boolean.vacuum_remote
            state: 'on'
        sequence:
          - service: vacuum.xiaomi_remote_control_start
            entity_id: vacuum.xiaomi_vacuum_cleaner
      - conditions:
          - condition: state
            entity_id: input_boolean.vacuum_remote
            state: 'off'
        sequence:
          - service: vacuum.xiaomi_remote_control_stop
            entity_id: vacuum.xiaomi_vacuum_cleaner

- id: main_brush_replace
  alias: Main Brush Replace
  trigger:
    - platform: numeric_state
      entity_id: sensor.vacuum_main_brush
      below: 2
  action:
    - service: notify.mobile_app_pixel_3a_xl
      data:
        title: Robot Vacuum Maintenance
        message: "The main brush on the vacuum needs replacing."

- id: side_brush_replace
  alias: Side Brush Replace
  trigger:
    - platform: numeric_state
      entity_id: sensor.vacuum_side_brush
      below: 2
  action:
    - service: notify.mobile_app_pixel_3a_xl
      data:
        title: Robot Vacuum Maintenance
        message: "The side brush on the vacuum needs replacing."

- id: filter_replace
  alias: Filter Replace
  trigger:
    - platform: numeric_state
      entity_id: sensor.vacuum_filter
      below: 2
  action:
    - service: notify.mobile_app_pixel_3a_xl
      data:
        title: Robot Vacuum Maintenance
        message: "The filter on the vacuum needs replacing."

- id: vacuum_sensor_cleaning
  alias: Vacuum Sensor Cleaning
  trigger:
    - platform: numeric_state
      entity_id: sensor.vacuum_sensor
      below: 2
  action:
    - service: notify.mobile_app_pixel_3a_xl
      data:
        title: Robot Vacuum Maintenance
        message: "The sensors on the vacuum needs cleaning."

- id: vacuum_finish
  alias: Vacuum Finish
  trigger:
    - platform: state
      entity_id: vacuum.xiaomi_vacuum_cleaner
      to: 'docked'
  condition:
    condition: and
    conditions:
    - condition: state
      entity_id:
        - input_boolean.vacuum_stop_notify
        - input_boolean.vacuum_daily
      state: 'off'
  action:
    - service: notify.mobile_app_pixel_3a_xl
      data:
        title: Robot Vacuum Finished
        message: "The vacuum finished cleaning for today!"

- id: empty_bin
  alias: Empty Bin
  trigger:
    - platform: state
      entity_id: counter.robo_empty
  condition:
    - condition: numeric_state
      entity_id: counter.robo_empty
      above: 5
  action:
    - service: notify.residents
      data:
        title: Empty Robot Vacuum Bin
        message: "The vacuum has been run {{ states('counter.robo_empty') }} times without the bin being emptied."

- id: vacuum_basement_notification
  alias: Vacuum Basement Notification
  trigger:
    - platform: numeric_state
      entity_id: counter.basement_vacuum
      above: 14
  action:
    - service: notify.residents
      data:
        title: Vacuum Basement
        message: "It's been a while since you vacuumed the basement. Might want to use the robot vacuum down there!"

- id: vacuum_upstairs_notification
  alias: Vacuum Upstairs Notification
  trigger:
    - platform: numeric_state
      entity_id: counter.upstairs_vacuum
      above: 10
  action:
    - service: notify.residents
      data:
        title: Vacuum Upstairs
        message: "It's been a while since you vacuumed upstairs. Might want to use the robot vacuum upstairs!"

################################
#E Master Switches Automations #
################################

- id: ib_first_floor
  alias: IB First Floor
  trigger:
    - platform: state
      entity_id: group.first_floor
  action:
    - choose:
      - conditions:
          - condition: state
            entity_id: group.first_floor
            state: 'on'
        sequence:
          - service: script.turn_on
            entity_id: script.first_floor_break
      - conditions:
          - condition: state
            entity_id: group.first_floor
            state: 'off'
        sequence:
    - service: input_boolean.turn_off
      entity_id: input_boolean.all_firstfloor

- id: ib_second_floor
  alias: IB Second Floor
  trigger:
    - platform: state
      entity_id: group.second_floor
  action:
    - choose:
      - conditions:
          - condition: state
            entity_id: group.second_floor
            state: 'on'
        sequence:
          - service: script.turn_on
            entity_id: script.second_floor_break
      - conditions:
          - condition: state
            entity_id: group.second_floor
            state: 'off'
        sequence:
    - service: input_boolean.turn_off
      entity_id: input_boolean.all_secondfloor

- id: ib_basement_floor
  alias: IB Basement Floor
  trigger:
    - platform: state
      entity_id: group.basement_floor
  action:
    - choose:
      - conditions:
          - condition: state
            entity_id: group.basement_floor
            state: 'on'
        sequence:
          - service: script.turn_on
            entity_id: script.basement_floor_break
      - conditions:
          - condition: state
            entity_id: group.basement_floor
            state: 'off'
        sequence:
    - service: input_boolean.turn_off
      entity_id: input_boolean.all_basement

- id: ib_outside
  alias: IB Outside
  trigger:
    - platform: state
      entity_id: group.outside
  action:
    - choose:
      - conditions:
          - condition: state
            entity_id: group.outside
            state: 'on'
        sequence:
          - service: script.turn_on
            entity_id: script.outside_break
      - conditions:
          - condition: state
            entity_id: group.outside
            state: 'off'
        sequence:
    - service: input_boolean.turn_off
      entity_id: input_boolean.all_outside      

- id: toggle_all_first_floor
  alias: Toggle All First Floor
  trigger:
    - platform: state
      entity_id: input_boolean.all_firstfloor
  action:
    - choose:
      - conditions:
          - condition: and
            conditions:
            - condition: state
              entity_id: input_boolean.all_firstfloor
              state: 'on'
            - condition: state
              entity_id: input_boolean.all_break
              state: 'off'
        sequence:
          - service: homeassistant.turn_on
            entity_id: group.first_floor
      - conditions:
          - condition: and
            conditions:
            - condition: state
              entity_id: input_boolean.all_firstfloor
              state: 'off'
            - condition: state
              entity_id: group.first_floor
              state: 'on'
        sequence:
          - service: homeassistant.turn_off
            entity_id: group.first_floor

- id: toggle_all_second_floor
  alias: Toggle All Second Floor
  trigger:
    - platform: state
      entity_id: input_boolean.all_secondfloor
  action:
    - choose:
      - conditions:
          - condition: and
            conditions:
            - condition: state
              entity_id: input_boolean.all_secondfloor
              state: 'on'
            - condition: state
              entity_id: input_boolean.all_break
              state: 'off'
        sequence:
          - service: homeassistant.turn_on
            entity_id: group.second_floor
      - conditions:
          - condition: and
            conditions:
            - condition: state
              entity_id: input_boolean.all_secondfloor
              state: 'off'
            - condition: state
              entity_id: group.second_floor
              state: 'on'
        sequence:
          - service: homeassistant.turn_off
            entity_id: group.secondfloor

- id: toggle_all_basement_floor
  alias: Toggle All Basement Floor
  trigger:
    - platform: state
      entity_id: input_boolean.all_basement
  action:
    - choose:
      - conditions:
          - condition: and
            conditions:
            - condition: state
              entity_id: input_boolean.all_basement
              state: 'on'
            - condition: state
              entity_id: input_boolean.all_break
              state: 'off'
        sequence:
          - service: homeassistant.turn_on
            entity_id: group.basement_floor
      - conditions:
          - condition: and
            conditions:
            - condition: state
              entity_id: input_boolean.all_basement
              state: 'off'
            - condition: state
              entity_id: group.basement_floor
              state: 'on'
        sequence:
          - service: homeassistant.turn_off
            entity_id: group.basement_floor
          - service: media_player.turn_off
            entity_id: media_player.basement_stereo
          - service: script.turn_on
            entity_id: script.timed_cpu_off

- id: toggle_all_outside
  alias: Toggle All Outside
  trigger:
    - platform: state
      entity_id: input_boolean.all_outside
  action:
    - choose:
      - conditions:
          - condition: and
            conditions:
            - condition: state
              entity_id: input_boolean.all_outside
              state: 'on'
            - condition: state
              entity_id: input_boolean.all_break
              state: 'off'
        sequence:
          - service: homeassistant.turn_on
            entity_id: group.outside
      - conditions:
          - condition: and
            conditions:
            - condition: state
              entity_id: input_boolean.all_outside
              state: 'off'
            - condition: state
              entity_id: group.outside
              state: 'on'
        sequence:
          - service: homeassistant.turn_off
            entity_id: group.outside

#############################
#F Notification Automations #
#############################

- id: weather_alert
  alias: Weather Alert
  trigger:
    - platform: state
      entity_id: sensor.weatheralerts
  condition:
    - condition: state
      entity_id: binary_sensor.weather_alert
      state: 'on'
  action:
    - service: switch.turn_on
      entity_id: switch.momentary_weather_alert_notification
    - service: notify.residents
      data:
        title: "{{ state_attr('sensor.weatheralerts', 'alerts')[states('sensor.weatheralerts')|int - 1].event }}"
        message: "{{ state_attr('sensor.weatheralerts', 'alerts')[states('sensor.weatheralerts')|int - 1].description }}"

- id: alli_battery
  alias: Alli Battery
  trigger:
    - platform: numeric_state
      entity_id: sensor.alli_battery
      below: 2.85
      for:
        minutes: 12
  action:
    - service: notify.mobile_app_pixel_3a_xl
      data:
        title: Alli's Collar Low Battery
        message: "Alli's collar has very low battery."

- id: hacs_updates
  alias: HACS Updates
  trigger:
    - platform: numeric_state
      entity_id: sensor.hacs
      above: 0
  action:
    service: notify.mobile_app_pixel_3a_xl
    data:
      title: HACS Updates
      message: "There are some HACS updates ready to be installed."

- id: ssl_certification_alert
  alias: SSL Certification Alert
  trigger:
    - platform: numeric_state
      entity_id: input_number.ssl_cert
      below: 25
  action:
    - service: notify.mobile_app_pixel_3a_xl
      data:
        title: SSL Certification Alert
        message: "Check to make sure your SSL certificate doesn't expire soon."

- id: alli_meds
  alias: Alli Meds
  trigger:
    - platform: time
      at: '18:00:00'
  condition:
    - condition: template
      value_template: "{{ now().day == 1 }}"
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.dog_med
    - service: script.turn_on
      entity_id: script.medications

- id: trash_alert
  alias: Trash Alert
  trigger:
    - platform: state
      entity_id: sensor.pickup_day
      from: 'Thu'
  action:
    - service: notify.residents
      data:
        title: Trash Alert
        message: "Trash pickup has been moved to {{ as_timestamp(state_attr('calendar.trash_pickup', 'start_time')) | timestamp_custom('%A') }}"

########################
#G Weather Automations #
########################

- id: windows
  alias: Windows
  trigger:
    - platform: state
      entity_id: input_boolean.window
  action:
    - choose:
      - conditions:
          - condition: state
            entity_id: input_boolean.window
            state: 'off'
        sequence:
          - service: script.turn_on
            entity_id: script.climate_reset
          - service: input_boolean.turn_off
            entity_id: input_boolean.window
      - conditions:
          - condition: state
            entity_id: input_boolean.window
            state: 'on'
        sequence:
          - alias: script.turn_on
            service: script.windows_open

- id: close_windows_auto
  alias: Close Windows Auto
  trigger:
    - platform: numeric_state
      entity_id: sensor.outside_temp
      above: 80
    - platform: numeric_state
      entity_id: sensor.outside_temp
      below: 65
  condition:
    - condition: state
      entity_id: input_boolean.window
      state: 'on'
  action:
    - service: script.turn_on
      entity_id: script.climate_reset
    - service: input_boolean.turn_off
      entity_id: input_boolean.window
    - service: notify.residents
      data:
        title: Windows Closed
        message: Weather is changing.  Time to close the windows.

- id: keep_windows_open
  alias: Keep Windows Open
  trigger:
    - platform: time_pattern
      minutes: 0
      seconds: 5
  condition:
    condition: and
    conditions:
    - condition: numeric_state
      entity_id: sensor.outside_temp
      below: 80
    - condition: numeric_state
      entity_id: sensor.outside_temp
      above: 65
    - condition: state
      entity_id: input_boolean.window
      state: 'on'
  action:
    - service: script.turn_on
      entity_id: script.windows_open

###############################
#H Home Assistant Automations #
###############################

- id: theme_set
  alias: Theme Set
  trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: sun.sun
  action:
    - choose:
      - conditions:
          - condition: state
            entity_id: sun.sun
            state: 'below_horizon'
        sequence:
          - service: frontend.set_theme
            data:
              name: red_night
      - conditions:
          - condition: state
            entity_id: sun.sun
            state: 'above_horizon'
        sequence:
          - service: frontend.set_theme
            data:
              name: red_day

- id: delay_automations_on_restart
  alias: Delay automations on restart
  trigger:
     - platform: homeassistant
       event: start
  action:
    - service: automation.turn_off
      data:
        entity_id:
          - group.all_automations
    - delay:
        seconds: 5
    - service: automation.turn_on
      data:
        entity_id:
          - group.all_automations
    - service: input_boolean.turn_on
      entity_id: input_boolean.basement_light_off_loop

- id: daily_snapshot_clean_up
  alias: Daily snapshot clean up
  trigger: 
    - platform: time
      at: '03:00:00'
  action:
    - service: clean_up_snapshots_service.clean_up

- id: perform_auto_backup
  alias: Perform Auto Backup
  trigger:
    - platform: time_pattern # Perform backup every 3 hours.
      hours: "/3"
  condition:
    - condition: numeric_state
      entity_id: counter.backup
      below: 4
  action:
    - service: counter.increment
      entity_id: counter.backup
    - service: auto_backup.snapshot_partial # Only perform a partial snapshot to save storage.
      data_template:
        name: "AutoBackup: {{ now().strftime('%a, %-I:%M %p (%d/%m/%Y)') }} Version: {{ states('sensor.current_version') }}"
        password: !secret backup_password
        addons:
          - Mosquitto broker
        folders:
          - homeassistant
          - share
          - ssl
          - addons/local
        keep_days: 2

- id: perform_daily_backup
  alias: Perform Daily Backup
  trigger:
    - platform: time
      at: "02:30:00"
  condition:
    condition: and
    conditions:
    - condition: numeric_state
      entity_id: counter.backup
      below: 12
    - condition: time # Perform backup every day except Mondays.
      weekday:
        - tue
        - wed
        - thu
        - fri
        - sat
        - sun
  action:
    - service: counter.increment
      entity_id: counter.backup
    - service: auto_backup.snapshot_full
      data_template:
        name: "DailyBackup: {{ now().strftime('%A, %B %-d, %Y') }} Version: {{ states('sensor.current_version') }}"
        password: !secret backup_password
        keep_days: 7

- id: perform_weekly_backup
  alias: Perform Weekly Backup
  trigger:
    - platform: time
      at: "02:30:00"
  condition:
    - condition: time # On Mondays perform a weekly backup
      weekday:
        - mon
  action:
    - service: counter.increment
      entity_id: counter.backup
    - service: auto_backup.snapshot_full
      data_template:
        name: "WeeklyBackup: {{ now().strftime('%A, %B %-d, %Y') }} Version: {{ states('sensor.current_version') }}"
        password: !secret backup_password
        keep_days: 28

- id: set_cert_data
  alias: Set Cert Data
  trigger:
    - platform: state
      entity_id: sensor.ssl_certificate_expiry
  condition:
    - condition: template
      value_template: "{{ states('sensor.ssl_certificate_expiry') != 'unavailable' }}"
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.ssl_cert
        value: "{{ states('sensor.ssl_certificate_expiry') }}"

- id: watt_hour_data
  alias: Watt Hour Data
  trigger:
    - platform: state
      entity_id: sensor.totalwhr
  condition:
    - condition: template
      value_template: "{{ states('sensor.totalwhr') != 'unavailable' }}"
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.watthour
        value: "{{ states('sensor.totalwhr') }}"

- id: cpu_hour_data
  alias: CPU Hour Data
  trigger:
    - platform: state
      entity_id: sensor.cpuwhr
  condition:
    - condition: template
      value_template: "{{ states('sensor.cpuwhr') != 'unavailable' }}"
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.cpuhour
        value: "{{ states('sensor.cpuwhr') }}"

- id: light_hour_data
  alias: Light Hour Data
  trigger:
    - platform: state
      entity_id: sensor.watthour
  condition:
    - condition: template
      value_template: "{{ states('sensor.watthour') != 'unavailable' }}"
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.lighthour
        value: "{{ states('sensor.watthour') }}"

- id: visitor
  alias: Visitors
  trigger:
    - platform: state
      entity_id: calendar.visitors
  action:
    - choose:
      - conditions:
          - condition: state
            entity_id: calendar.visitors
            state: 'on'
        sequence:
          - service: input_boolean.turn_on
            entity_id: input_boolean.visitor
          - service: notify.mobile_app_pixel_3a_xl
            data:
              title: Visitors Coming
              message: Change Ecobee Sleep to include downstairs
      - conditions:
          - condition: state
            entity_id: calendar.visitors
            state: 'off'
        sequence:
          - service: input_boolean.turn_off
            entity_id: input_boolean.visitor
          - service: notify.mobile_app_pixel_3a_xl
            data:
              title: Visitors Left
              message: Change Ecobee Sleep to remove downstairs

- id: party
  alias: Party
  trigger:
    - platform: state
      entity_id: calendar.party
  action:
    - choose:
      - conditions:
          - condition: state
            entity_id: calendar.party
            state: 'on'
        sequence:
          - service: input_boolean.turn_on
            entity_id: input_boolean.party
      - conditions:
          - condition: state
            entity_id: calendar.party
            state: 'off'
        sequence:
          - service: input_boolean.turn_off
            entity_id: input_boolean.party

- id: update_watt_hour
  alias: Update Watt Hour
  trigger:
    - platform: time_pattern
      minutes: '/15'
      seconds: '00'
  action:
    - service: python_script.watthour

- id: drive_watthour_update
  alias: Drive Watthour Update
  trigger:
    - platform: time
      at: '12:00:00'
  action:
    - service: ifttt.trigger
      data_template: {"event":"WattHour_Month", "value1":"{{ states('input_number.lighthour') }}", "value2":"{{ states('input_number.cpuhour') }}", "value3":"{{ states('sensor.auxwhr') }}"}#, "value4":"{{ states('input_number.watthour') }}", "value5":"20"}

- id: allow_motion
  alias: Allow Motion
  trigger:
    - platform: time_pattern
      minutes: '/5'
      seconds: '00'
  condition:
    condition: and
    conditions:
    - condition: time
      before: '22:00:00'
    - condition: time
      after: '8:00:00'
    - condition: or
      conditions:
      - condition: state
        entity_id:
          - input_boolean.basement
          - input_boolean.livingroom
          - input_boolean.kitchen
        state: 'off'
      - condition: state
        entity_id: input_boolean.goodnight
        state: 'on'
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.basement
    - service: input_boolean.turn_on
      entity_id: input_boolean.livingroom
    - service: input_boolean.turn_on
      entity_id: input_boolean.kitchen
    - service: input_boolean.turn_off
      entity_id: input_boolean.goodnight

- id: occupancy_counter
  alias: Occupancy Counter
  trigger:
    - platform: homeassistant
      event: start
    - platform: time_pattern
      minutes: '/1'
  action:
    - service: python_script.occupancy_counter
    
- id: occupancy_python_script
  alias: Occupancy Python Script
  trigger:
    - platform: time_pattern
      minutes: '/1'
  condition:
    condition: and
    conditions:
    - condition: state
      entity_id: input_boolean.vacation
      state: 'off'
    - condition: state
      entity_id: input_boolean.visitor
      state: 'off'
    - condition: state
      entity_id: input_boolean.party
      state: 'off'
  action:
    - service: python_script.occupancy

######################
#I Other Automations #
######################

- id: fade_in_lights_for_sunset
  alias: Fade in lights for sunset
  trigger:
    - platform: sun
      event: sunset
      offset: -01:00:00
  condition:
    condition: or
    conditions:
    - condition: state
      entity_id: group.residents
      state: home
    - condition: state
      entity_id:
        - input_boolean.vacation
        - input_boolean.im_home
        - input_boolean.visitor
      state: 'on'
  action:
    - service: scene.turn_on
      entity_id: scene.sunset
    - service: script.turn_on
      entity_id: script.sunset_switch

- id: turn_off_all_lights_at_night
  alias: Turn off all lights at night
  trigger:
    - platform: time
      at: '23:30:00'
      # at: '02:30:00'
  condition:
    - condition: state
      entity_id: input_boolean.party
      state: 'off'
  action:
    - service: homeassistant.turn_off
      entity_id: group.all_lights
    - service: homeassistant.turn_off
      entity_id: group.outside
    - service: homeassistant.turn_off
      entity_id: group.holiday

- id: turn_off_all_lights_at_night_party
  alias: Turn off all lights at night party
  trigger:
    - platform: state
      entity_id: input_boolean.party
      to: 'off'
  condition:
    condition: or
    conditions:
    - condition: time
      after: '23:30:00'
      # after: 02:30:00
    - condition: sun
      before: sunrise
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.all_firstfloor
    - service: input_boolean.turn_off
      entity_id: input_boolean.all_secondfloor
    - service: input_boolean.turn_off
      entity_id: input_boolean.all_basement
    - service: input_boolean.turn_off
      entity_id: input_boolean.all_outside
    - service: homeassistant.turn_off
      entity_id: group.holiday

- id: turn_off_all_lights_at_night_on_vacation
  alias: Turn off all lights at night on vacation
  trigger:
    - platform: time
      at: '23:00:00'
  condition:
  - condition: state
    entity_id: input_boolean.vacation
    state: 'on'
  action:
    - delay: '{{ (range(0, 1)|random|int) }}:{{ (range(1, 59)|random|int) }}:00'
    - service: homeassistant.turn_off
      entity_id: group.all_lights
    - service: homeassistant.turn_off
      entity_id: group.firstfloor
    - service: homeassistant.turn_off
      entity_id: group.bedroom

- id: turn_off_all_lights_at_morning_on_vacation
  alias: Turn off all lights at morning on vacation
  trigger:
    - platform: time
      at: '8:00:00'
  condition:
    - condition: state
      entity_id: input_boolean.vacation
      state: 'on'
  action:
    - delay: '{{ (range(0, 1)|random|int) }}:{{ (range(1, 59)|random|int) }}:00'
    - service: homeassistant.turn_off
      entity_id: group.all_lights
    - service: homeassistant.turn_off
      entity_id: group.firstfloor
    - service: homeassistant.turn_off
      entity_id: group.bedroom

- id: temperature_party
  alias: Temperature Party
  trigger:
    - platform: time_pattern
      minutes: 0
      seconds: 5
  condition:
    - condition: state
      entity_id: input_boolean.party
      state: 'on'
  action:
    - service: script.turn_on
      entity_id: script.party_temp
    
- id: update_alli
  alias: Update Alli
  trigger:
    - platform: state
      entity_id: group.alli_locate
      to: 'on'
  action:
    - service: script.turn_on
      entity_id: script.alli_location_spreadsheet

- id: dog_meds_flag
  alias: Dog Meds Flag
  trigger:
    - entity_id: sensor.alli_button
      platform: numeric_state
      above: 0
      below: 2
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.dog_med